<!DOCTYPE html>
<head>
    <meta charset="utf8">
    <meta viewport="width=device-width, initial-scale=1">
    <title>Dashboard</title>
    <style>
        html {
            max-width: 70ch;
            padding: 3em 1em;
            margin: auto;
            line-height: 1.75;
            font-size: 1.25em;
        }
        [v-cloak] {
            display: none
        }
        .pixellated {
            -ms-interpolation-mode: nearest-neighbor;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }
        @keyframes green-appear {
            from {
                background-color: lightgreen;
            }
            to {
                background-color: inherit;
            }
        }
        @keyframes blinky {
            from {
                opacity: 0;
            }
            40% {
                opacity: 0;
            }
            60% {
                opacity: 1;
            }
            to {
                opacity: 1;
            }
        }
        .chess {
            font-size: 150%;
            line-height: 1;
        }
    </style>

    <!-- <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/redux@4.2.0/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@8.0.4/dist/react-redux.js" crossorigin></script>
    <script src="https://unpkg.com/redux-saga@1.2.1/dist/redux-saga.umd.js" crossorigin></script> -->

    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@4.2.0/dist/redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@8.0.4/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux-saga@1.2.1/dist/redux-saga.umd.min.js" crossorigin></script>
    </head>
<body>

<main></main>

<script>
    const $ = React.createElement;
    "h2 section a table tbody tr td span div br".split(' ').forEach(tag => window['$'+tag] = $.bind(null, tag));

    function usePoll(url, millis, initial, process=(x)=>x) {
        const [data, setData] = React.useState(initial);

        React.useEffect(() => {
            const fetchUpdate = () => fetch(url)
                .then(res => res.json())
                .then(data => setData(process(data)));

            fetchUpdate();
            const timer = setInterval(fetchUpdate, millis);
            return () => clearInterval(timer);
        }, []);

        return data;
    }

    function Familiars() {
        const players = usePoll('https://www.familiars.io/api/radar', 2000, [], players => [
            players.filter(p => p[0].y < 0x4000).map(([{x,y},pvp], i) => ({key:i,x,y,pvp})),
            players.filter(p => p[0].y >= 0x4000).map(([{x,y},pvp], i) => ({key:i,x,y:y-0x4000,pvp})),
        ]);
        return $(FamiliarsComponent, {players});
    }
    function FamiliarsComponent({players}) {
        return $section({id:'familiars'},
            $h2({},
                $a({href:"https:///www.familiars.io", target:"_blank"}, 'Familiars')
            ),
            ...players.map((players, layer) =>
                $div({className:"pixellated", style:{display:"inline-block", position:"relative", width:'184px', height:'184px', backgroundImage:`url(familiars-map${layer}.png)`, backgroundSize:'cover', marginRight:'16px'}},
                players.map(player => $div({
                    key: player.key, style:{width:'6px', height:'6px', position:'absolute', animation: '0.5s linear infinite alternate blinky', left:`${player.x*2-1}px`, top:`${player.y*2-1}px`, backgroundColor:player.pvp?'red':'white'}
                })))
            )
        )
    }

    function Rpnow() {
        // rooms.sort((a,b) => Math.max(...b.users.map(u=>u.lastMessage)) - Math.max(...a.users.map(u=>u.lastMessage)))
        const rooms = usePoll('https://rpnow.nfshost.com', 3000, []);

        const [now, setNow] = React.useState(Date.now());
        React.useEffect(() => {
            const timer = setInterval(() => setNow(Date.now()), 1000);
            return () => clearInterval(timer);
        }, [])

        return $(RpnowComponent, {rooms, now});
    }
    function RpnowComponent({rooms, now}) {
        function icon(user) {
            // if (now - user.lastMessage < 15000) return '💬'
            if (user.age === 0) return '♟︎'
            if (user.age === 1) return '♞'
            if (user.age === 7) return '♝'
            if (user.age === 30) return '♜'
            if (user.age === 90) return '♛'
            if (user.age === 365) return '♚'
            return '❓'
        }
        function iconColor(user) {
            // return ['#CC0000', '#00AA00', '#0000DD', '#CC00CC'][user.flavor];

            // const h = parseInt(user.tempId.slice(0,1), 16) / 16 * 360;
            // return `hsl(${h}, 100%, 30%)`;

            if (now - user.lastMessage < 15000) return 'blue'
            return 'black'
        }

        const legendEntry = (piece, age) => $span({style:{marginRight:'20px'}},
            $span({className:'chess'}, piece),
            age,
        );

        return $section({id:'rpnow'},
            $h2({},
                $a({href:"https:///www.rpnow.net", target:"_blank"}, 'RPNow')
            ),
            'How new the user is:',
            $br(),
            legendEntry('♟︎', 'new'),
            legendEntry('♞', 'days'),
            legendEntry('♝', 'weeks'),
            legendEntry('♜', 'months'),
            legendEntry('♛', '3+ months'),
            legendEntry('♚', 'years'),
            $div({style:{marginTop:'10px'}},
                rooms.map(room => $span({key:room.tempId, style: {border:'solid 2px', display:'inline-block', marginRight:'10px', marginBottom:'10px'}},
                    room.users.map(user => $span({key:user.tempId, style: {padding: "padding: 0 10px", color: iconColor(user)}},
                        $span({className:'chess'}, icon(user)),
                        `${user.messages}`,

                    ))
                ))
            )
        );
    }

    function makeIpv4Store() {
        function artificiallyStaggerDates(records) {
            // Assuming their dates are ordered newest-to-oldest.
            // Artificially stagger timestamps to make it cooler when they roll in
            while (records.length > 0) {
                const top = records.filter(r => r[2] === records[0][2]);
                top.forEach((r, i, arr) => r[2] -= i/arr.length);
                records = records.slice(top.length);
            }
        }
        const INITIAL_STATE = {
            shown: [],
            upcoming: [],
            serverTime: null,
            windowTime: 0,
        }
        function reducer(state, action) {
            if (action.type === 'freshData') {
                const { data: info } = action;
                const serverTime = Math.max(info.now[0] + info.now[1]/1e9, info.recent[0][2]);
                if (state.serverTime == null) {
                    // first update
                    const windowTime = (serverTime - 10);
                    const shown = info.recent.filter(([,,t]) => t < windowTime).slice(0, 7);
                    const upcoming = info.recent.filter(([,,t]) => t >= windowTime && t < (serverTime|0));
                    artificiallyStaggerDates(shown);
                    artificiallyStaggerDates(upcoming);
                    return { serverTime, windowTime, shown, upcoming };
                } else {
                    // subsequent updates
                    const newRecords = info.recent.filter(([,,t]) => t > (state.upcoming[0] || state.shown[0])[2] && t < (serverTime|0));
                    artificiallyStaggerDates(newRecords);
                    const upcoming = [...newRecords, ...state.upcoming];
                    return { ...state, serverTime, upcoming };
                }
            } else if (action.type === 'advanceWindow') {
                // do nothing if we haven't initialized yet
                if (!state.windowTime) return state;

                const { seconds: s } = action;
                const windowDelta = state.serverTime - state.windowTime;
                let { windowTime } = state;
                if (windowDelta - s < 1) {}
                else if (windowDelta - s < 5) windowTime += s / 2
                else if (windowDelta - s < 10) windowTime += s;
                else if (windowDelta - s < 15) windowTime += s * 2;
                else windowTime = state.serverTime - 15;

                // take the end of 'upcoming' and put at the front of 'shown' where times are within the new window
                if (state.upcoming.length > 0 && state.upcoming[state.upcoming.length-1][2] < windowTime) {
                    const spliceIndex = state.upcoming.findIndex(([,,t]) => t < windowTime);
                    const upcoming = [...state.upcoming];
                    const shown = [...upcoming.splice(spliceIndex), ...state.shown].slice(0, 7);
                    return { ...state, windowTime, upcoming, shown }
                } else {
                    return { ...state, windowTime };
                }
            } else {
                return state;
            }
        }

        const sagaMiddleware = ReduxSaga.default();

        const store = Redux.createStore(reducer, INITIAL_STATE, Redux.applyMiddleware(sagaMiddleware));

        function* pollingSaga() {
            while (true) {
                const data = yield fetch('https://ipv4.games/recent')
                    .then(res => {
                        if (res.status === 200) return res;
                        else throw new Error(`Error ${res.status}`)
                    })
                    .then(res => res.json())
                    .catch(e => null)
                if (data != null) {
                    yield ReduxSaga.effects.put({ type: 'freshData', data });
                }
                yield ReduxSaga.effects.delay(3000);
            }
            yield takeLatest('requestPoll', doFetch)
        }

        function* advanceWindowSaga() {
            while (true) {
                yield ReduxSaga.effects.delay(100);
                yield ReduxSaga.effects.put({ type: 'advanceWindow', seconds: 0.1 });
            }
        }

        sagaMiddleware.run(pollingSaga);
        sagaMiddleware.run(advanceWindowSaga);

        return store;
    }
    const ipv4Store = makeIpv4Store();

    function Ipv4() {
        const shown = ReactRedux.useSelector(state => state.shown);
        return $(Ipv4Component, {shown});
    }
    function Ipv4Component({shown}) {
        const formatIP = (n) => `${n>>>24}.${(n>>>16)&255}.${(n>>>8)&255}.${n&255}`;

        return $section({id:'ipv4'},
            $h2({},
                $a({href:"https://ipv4.games", target:"_blank"}, 'ipv4.games'),
            ),
            $table({style: {fontFamily:'monospace', borderCollapse:'collapse'}}, 
                $tbody({},
                    shown.map(([ip, name, timestamp]) => $tr({key:timestamp, style:{animation:'green-appear 0.5s normal forwards ease-in-out'}},
                        $td({style:{width:'18ch'}}, formatIP(ip)),
                        $td({style:{width:'20ch', maxWidth:'20ch', overflow:'hidden', whiteSpace: 'nowrap', textOverflow:'ellipsis'}}, `${name}`),
                    ))
                )
            ),
        );
    }

    function ChatChat() {
        const rooms = usePoll('https://chatchat.nfshost.com', 20000, []);
        return $(ChatChatComponent, {rooms});
    }
    function ChatChatComponent({rooms}) {
        return $section({id:'chatchat'},
            $h2({},
                $a({href:"https://chatchatgame.netlify.app", target:"_blank"}, 'ChatChat')
            ),
            $table({style: {fontFamily:'monospace', borderCollapse:'collapse'}},
                $tbody({style: {verticalAlign: 'top'}},
                    rooms.map(room => $tr({key: room.id, style:{animation:'green-appear 0.5s normal forwards ease-in-out'}},
                        $td({style: {width:'18ch', maxWidth:'18ch', overflow:'hidden', textOverflow:'ellipsis'}}, `${room.name}`),
                        $td({style: {width:'10ch', maxWidth:'10ch', wordWrap:'break-word'}}, 
                            room.cats > 0 ? Array(room.cats).fill('🐈').join(' ') : '(empty)'
                        )
                    ))
                )
            )
        )
    }

    function App() {
        return $(React.Fragment, {},
            $(Familiars),
            $(Rpnow),
            $(ReactRedux.Provider, {store: ipv4Store},
                $(Ipv4),
            ),
            $(ChatChat),
        )
    }

    ReactDOM.createRoot(document.querySelector('main')).render($(App));
</script>

</body>